#include <iostream>
#include <stack>
#include <utility>
#include <fstream>
#include <sstream>
#include <chrono>
#include <vector>

using namespace std::chrono;

void qswap(int& a, int& b) {
    int temp = a;
    a = b;
    b = temp;
}


int Partition(int A[], int l, int p) {
    int pivot = A[l];
    int i = l;
    int j = p;

    while (i < j) {
        while (i <= p && A[i] <= pivot) ++i;
        while (j >= l && A[j] > pivot) --j;
        if (i < j) {
            qswap(A[i], A[j]);
        }
    }
    qswap(A[l], A[j]);
    return j;
}


void StackQSort(int A[], int l, int p) {
    if (l >= p) return;

    std::stack<std::pair<int, int>> S;
    S.push(std::make_pair(l, p));

    while (!S.empty()) {
        auto node = S.top();
        S.pop();
        int lew = node.first;
        int praw = node.second;

        while (lew < praw) {
            int m = Partition(A, lew, praw);

            int leftSize = m - lew;
            int rightSize = praw - m;

            if (leftSize < rightSize) {
                if (m + 1 <= praw)
                    S.push(std::make_pair(m + 1, praw));
                praw = m - 1;
            }
            else {
                if (lew <= m - 1)
                    S.push(std::make_pair(lew, m - 1));
                lew = m + 1;
            }
        }
    }
}


bool VerifySorted(int A[], int n) {
    for (int i = 1; i < n; ++i) {
        if (A[i] < A[i - 1]) {
            return false;
        }
    }
    return true;
}


int main() {
    std::ifstream file("wynik.txt");
    if (!file) {
        std::cerr << "Blad otwarcia pliku!\n";
        return 1;
    }

    std::string line;
    std::getline(file, line);
    std::stringstream ss(line);

    std::vector<int> vec;
    std::string value;

    while (std::getline(ss, value, ',')) {
        if (!value.empty()) {
            vec.push_back(std::stoi(value));
        }
    }

    int n = vec.size();
    int* A = new int[n];
    for (int i = 0; i < n; i++)
        A[i] = vec[i];

    auto start = high_resolution_clock::now();

    StackQSort(A, 0, n - 1);

    if (VerifySorted(A, n)) {
        std::cout << "Dane posortowane poprawnie.\n";
    }
    else {
        std::cout << "BLAD sortowania!\n";
    }

    auto end = high_resolution_clock::now();
    auto duration = duration_cast<milliseconds>(end - start).count();

    std::cout << "Czas sortowania: " << duration << " ms\n";

    delete[] A;
    return 0;
}
